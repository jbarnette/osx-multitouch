require "autotest/restart"

Autotest.add_hook :initialize do |at|
  at.testlib = "minitest/autorun"

  def at.path_to_classname s
    sep = File::SEPARATOR
    f = s.sub(/^test#{sep}/, '').sub(/\.rb$/, '').split(sep)
    f = f.map { |path| path.split(/_|(\d+)/).map { |seg| seg.capitalize }.join }
    f.last << "Test" unless f.last =~ /Test$/
    f.join "::"
  end

  at.clear_mappings

  at.add_exception ".git"
  at.add_exception ".gitignore"
  at.add_exception "CHANGELOG.rdoc"
  at.add_exception "Manifest.txt"
  at.add_exception "README.rdoc"
  at.add_exception "Rakefile"
  at.add_exception "lib/*.bundle"
  at.add_exception "tmp"

  at.add_mapping(/^lib\/(.*)\.rb$/)   { |_, m| "test/#{m[1]}_test.rb" }
  at.add_mapping(/^test.*_test\.rb$/) { |f, _| f }
end
